@model List<MonitoringSystem.Models.ApplicationUser>

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "USERS";
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
<input type="hidden" id="__RequestVerificationToken" value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />

<div class="users-page container-fluid py-4">

    <!-- ================= USERS SECTION ================= -->
    <div id="usersSection">
        <div class="card shadow-sm rounded-4 p-4">

            <!-- HEADER + CREATE COMPANY BUTTON -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Users</h5>
                <button id="showCreateCompanyForm" class="btn btn-primary">
                    Create Company
                </button>
            </div>

            <!-- FILTERS -->
            <div class="row g-3 mb-4 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Year</label>
                    <select id="yearFilter" class="form-select filter-box">
                        <option value="">All</option>
                        <option value="2026">2026</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold">Search by Name</label>
                    <input type="text" id="searchName" class="form-control filter-box" placeholder="Type..." />
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold">Role</label>
                    <select id="roleFilter" class="form-select filter-box">
                        <option value="">All</option>
                        <option value="Student">Student</option>
                        <option value="Company">Company</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>

            <!-- USERS TABLE -->
            <div class="table-responsive">
                <table class="table table-hover table-borderless align-middle mb-0" id="usersTable">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            var role = user.Roles.FirstOrDefault() ?? "No Role";
                            var fullName = $"{user.FirstName} {user.LastName}";
                            <tr data-id="@user.Id"
                                data-fullname="@fullName"
                                data-email="@user.Email"
                                data-role="@role"
                                data-year="@user.Year">
                                <td>@fullName</td>
                                <td>@user.Email</td>
                                <td>@role</td>
                                <td class="text-end">
                                    <div class="dropdown dropend d-inline-block">
                                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown"></button>
                                        <ul class="dropdown-menu shadow-sm">
                                            <li><a class="dropdown-item edit-btn" href="#">Edit</a></li>
                                            <li><a class="dropdown-item delete-btn" href="#">Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- ================= CREATE COMPANY + CONTACT PERSON WRAPPER ================= -->
    <div id="createCompanyWrapper" style="display: none;">

        <!-- ================= CREATE COMPANY SECTION ================= -->
        <div class="card shadow-sm rounded-4 p-4 mb-4">
            <h5>Create Company</h5>
            <form id="createCompanyFormPage">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyNamePage" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="companyTypePage" required>
                            <option value="">Select Type</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Manufacturing">Manufacturing</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">SEC ID</label>
                        <input type="text" class="form-control" id="companySecIdPage">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" class="form-control" id="companyMobilePage">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Website</label>
                        <input type="text" class="form-control" id="companyWebsitePage">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">TIN ID</label>
                        <input type="text" class="form-control" id="companyTinPage">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-control" id="companyAddressPage">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="companyEmailPage" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="companyPasswordPage" required>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-12">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="companyDescriptionPage" rows="2"></textarea>
                    </div>
                </div>
            </form>
        </div>

        <!-- ================= CONTACT PERSON SECTION ================= -->
        <div class="card shadow-sm rounded-4 p-4 mb-4">
            <h5>Contact Person</h5>
            <form id="contactPersonForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="contactFullName" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" class="form-control" id="contactMobile">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control" id="contactPosition">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-control" id="contactAddress">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="contactEmail">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Department</label>
                        <input type="text" class="form-control" id="contactDepartment">
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">TIN Number</label>
                        <input type="text" class="form-control" id="contactTIN">
                    </div>
                </div>
            </form>
        </div>

        <!-- ================= CREATE + CANCEL BUTTONS (OUTSIDE CARDS) ================= -->
        <div class="d-flex justify-content-end gap-2 mb-4">
            <button id="submitCreateCompany" class="btn" style="background-color: #02B508; color: #fff;">Create</button>
            <button id="cancelCreateCompany" class="btn" style="background-color: #FD0606; color: #fff;">Cancel</button>
        </div>


    </div>

</div>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="editFullName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-control" id="editRole">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
    const tbody = document.querySelector("#usersTable tbody");
    let rowToEdit = null;
    const yearFilter = document.getElementById("yearFilter");
    const searchName = document.getElementById("searchName");
    const roleFilter = document.getElementById("roleFilter");
    const token = document.getElementById("__RequestVerificationToken").value;

    const usersSection = document.getElementById("usersSection");
    const createCompanyWrapper = document.getElementById("createCompanyWrapper");
    const showCreateBtn = document.getElementById("showCreateCompanyForm");

    // ===== FILTER TABLE =====
    function filterTable() {
        const yearVal = yearFilter.value;
        const nameVal = searchName.value.toLowerCase();
        const roleVal = roleFilter.value;
        [...tbody.rows].forEach(row => {
            let show = true;
            const fullName = row.dataset.fullname.toLowerCase();
            if (yearVal && row.dataset.year !== yearVal) show = false;
            if (nameVal && !fullName.includes(nameVal)) show = false;
            if (roleVal && row.dataset.role !== roleVal) show = false;
            row.style.display = show ? "" : "none";
        });
    }
    [yearFilter, searchName, roleFilter].forEach(el => el.addEventListener("input", filterTable));

    // ===== EDIT USER =====
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", e => {
            e.preventDefault();
            rowToEdit = btn.closest("tr");
            editFullName.value = rowToEdit.dataset.fullname;
            editEmail.value = rowToEdit.dataset.email;
            editRole.value = rowToEdit.dataset.role;
            editPassword.value = "";
            bootstrap.Modal.getOrCreateInstance(editModal).show();
        });
    });

    document.getElementById("editForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        if (!rowToEdit) return;
        const id = rowToEdit.dataset.id;
        const fullName = editFullName.value;
        const email = editEmail.value;
        const role = editRole.value;
        const password = editPassword.value;
        const res = await fetch("/Admin/EditUser", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": token
            },
            body: JSON.stringify({ Id: id, FullName: fullName, Email: email, Role: role, Password: password })
        });
        const data = await res.json();
        if (data.success) {
            rowToEdit.dataset.fullname = fullName;
            rowToEdit.dataset.email = email;
            rowToEdit.dataset.role = role;
            rowToEdit.cells[0].textContent = fullName;
            rowToEdit.cells[1].textContent = email;
            rowToEdit.cells[2].textContent = role;
            bootstrap.Modal.getInstance(editModal).hide();
        } else alert(data.message || "Update failed");
    });

    // ===== DELETE USER =====
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
            e.preventDefault();
            const row = btn.closest("tr");
            if (!confirm("Delete this user?")) return;
            const res = await fetch("/Admin/DeleteUser", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": token
                },
                body: JSON.stringify({ Id: row.dataset.id })
            });
            const data = await res.json();
            if (data.success) row.remove();
            else alert("Delete failed");
        });
    });

    // ===== SHOW CREATE COMPANY + CONTACT PERSON WRAPPER =====
    showCreateBtn.addEventListener("click", () => {
        usersSection.style.display = "none";
        createCompanyWrapper.style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ===== CANCEL CREATE =====
    document.getElementById("cancelCreateCompany").addEventListener("click", () => {
        createCompanyWrapper.style.display = "none";
        usersSection.style.display = "block";
    });

    // ===== CREATE COMPANY + CONTACT PERSON =====
    document.getElementById("submitCreateCompany").addEventListener("click", () => {
        document.getElementById("createCompanyFormPage").dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
    });

    // Existing create company form submit
    document.getElementById("createCompanyFormPage").addEventListener("submit", async function(e){
        e.preventDefault();

        // Collect company fields
        const companyData = {
            Name: document.getElementById("companyNamePage").value.trim(),
            Type: document.getElementById("companyTypePage").value,
            SecId: document.getElementById("companySecIdPage").value.trim(),
            Mobile: document.getElementById("companyMobilePage").value.trim(),
            Website: document.getElementById("companyWebsitePage").value.trim(),
            Tin: document.getElementById("companyTinPage").value.trim(),
            Address: document.getElementById("companyAddressPage").value.trim(),
            Email: document.getElementById("companyEmailPage").value.trim(),
            Description: document.getElementById("companyDescriptionPage").value.trim(),
            Password: document.getElementById("companyPasswordPage").value
        };

        // Collect contact person fields
        const contactData = {
            FullName: document.getElementById("contactFullName").value.trim(),
            Mobile: document.getElementById("contactMobile").value.trim(),
            Position: document.getElementById("contactPosition").value.trim(),
            Address: document.getElementById("contactAddress").value.trim(),
            Email: document.getElementById("contactEmail").value.trim(),
            Department: document.getElementById("contactDepartment").value.trim(),
            TIN: document.getElementById("contactTIN").value.trim()
        };

        // Combine both data
        const payload = { Company: companyData, Contact: contactData };

        const res = await fetch("/Admin/CreateCompany", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": token
            },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        if(data.success){
            alert("Company and Contact Person created successfully!");
            location.reload();
        } else alert(data.message || "Failed to create company");
    });
</script>
