@* _AdminLayout.cshtml *@
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] | Admin Panel</title>

    <!-- CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/Profile.css" />
    <link rel="stylesheet" href="~/css/darkmode.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

    @RenderSection("Styles", required: false)
</head>
<body>
<div class="sidebar-overlay"></div>

<!-- LEFT SIDEBAR -->
<aside class="admin-sidebar">
    <div class="admin-logo-header">
        <img src="~/images/ctu-logo.png" class="admin-logo" />
        <div class="admin-logo-text">BALAMBAN CAMPUS</div>
    </div>

    <!-- School Year Dropdown -->
    <div class="sidebar-schoolyear-wrapper">
        <div class="sidebar-schoolyear mb-3 px-3">
            <label class="text-muted small mb-1">School Year</label>
            <select id="schoolYearDropdown" class="form-select form-select-sm">
                @{
                    int systemStartYear = 2025;
                    int currentYear = DateTime.Now.Year;
                    int selectedYear = ViewBag.SchoolYear ?? currentYear;
                    if (Context.Request.Cookies.ContainsKey("SelectedSchoolYear"))
                        int.TryParse(Context.Request.Cookies["SelectedSchoolYear"], out selectedYear);
                    for (int y = currentYear; y >= systemStartYear; y--)
                    {
                        var selectedAttr = (y == selectedYear) ? " selected" : "";
                        @: <option value="@y"@selectedAttr>@y</option>
                    }
                }
            </select>
        </div>
    </div>

    <nav class="admin-menu">
        <a asp-action="Dashboard" asp-controller="Admin" class="menu-link" id="dashboardBtn"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a>
        <a asp-action="Users" asp-controller="Admin" class="menu-link"><i class="bi bi-person-fill"></i> <span>Users</span></a>
        <a asp-action="Company" asp-controller="Admin" class="menu-link"><i class="bi bi-building"></i> <span>Company</span></a>
        <a asp-action="Messages" asp-controller="Admin" class="menu-link"><i class="bi bi-envelope-fill"></i> <span>Messages</span></a>
        <a asp-action="Reports" asp-controller="Admin" class="menu-link"><i class="bi bi-file-bar-graph-fill"></i> <span>Reports</span></a>
        <hr />
    </nav>

    <!-- LOGOUT BUTTON (POST) -->
    <div class="sidebar-logout">
        <a href="javascript:void(0);" onclick="document.getElementById('logoutForm').submit();" class="btn-logout">
            <i class="bi bi-box-arrow-right"></i> <span>Logout</span>
        </a>
        <form id="logoutForm" asp-controller="Account" asp-action="Logout" method="post" class="d-none">
            @Html.AntiForgeryToken()
        </form>
    </div>
</aside>

<!-- TOP BAR -->
<header class="admin-topbar d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-light d-none d-md-inline-flex me-2" id="desktopSidebarToggle"><i class="bi bi-list"></i></button>
        <button class="btn btn-sm btn-light d-md-none me-2" id="sidebarToggle"><i class="bi bi-list"></i></button>
        <i class="bi bi-house-fill me-2"></i>
        <span class="topbar-title">@ViewData["Title"]</span>
    </div>

    <div class="d-flex align-items-center gap-3">

        <!-- Dark Mode Toggle -->
        <div id="themeToggle" style="cursor:pointer;">
            <i class="bi bi-moon-fill fs-5" id="themeIcon"></i>
        </div>

        <!-- Notifications -->
        <div class="position-relative" id="notifBell" style="cursor:pointer;">
            <i class="bi bi-bell-fill fs-5"></i>
            <span class="notif-dot"></span>
            <div class="notif-popup shadow-sm bg-white rounded p-2"
                 style="position:absolute; right:0; top:30px; width:300px; max-height:400px; overflow-y:auto; z-index:1050;">
                <h6 class="fw-bold mb-2">Notifications</h6>
                <ul id="notifList" class="list-unstyled mb-0"></ul>
                <div class="text-center mt-2">
                    <button class="btn btn-sm btn-outline-secondary w-100" id="clearNotifsBtn">Mark all as read</button>
                </div>
            </div>
        </div>

        <!-- Profile Dropdown -->
        <div class="dropdown">
            <div class="d-flex align-items-center gap-2 dropdown-toggle" role="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="cursor:pointer;">
                <div class="d-flex flex-column" style="font-size: 0.75rem;" id="sidebarAdminName">
                    <strong id="sidebarAdminFullName">Administrator</strong>
                    <span>Admin</span>
                </div>
            </div>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                <li>
                    <a class="dropdown-item" href="javascript:void(0);" id="viewProfileBtn">
                        View Profile
                    </a>
                </li>
                <li><a href="javascript:void(0);" onclick="document.getElementById('logoutForm').submit();" class="dropdown-item">Logout</a></li>
            </ul>
        </div>
    </div>
</header>

<!-- MAIN CONTENT -->
<main class="admin-content" id="adminMainContent">
    @RenderBody()
</main>

<!-- PROFILE TEMPLATE -->
<script type="text/template" id="profileTemplate">
    <div class="profile-page text-white">
        <!-- BANNER -->
        <div class="profile-banner position-relative"
             style="height:260px;background:#e5e5e5 url('/images/banner-placeholder.jpg') center/cover;">
            <button class="btn btn-warning btn-sm position-absolute end-0 bottom-0 m-3">
                <i class="bi bi-camera"></i>
            </button>
        </div>

        <!-- PROFILE HEADER -->
        <div class="container-fluid px-4">
            <div class="d-flex align-items-end gap-4" style="margin-top:-70px;">
                <div class="position-relative">
                    <img src="/images/ctu-logo.png"
                         class="rounded-circle border border-3 border-dark"
                         style="width:140px;height:140px;object-fit:cover;">
                    <span class="position-absolute bottom-0 end-0 bg-warning rounded-circle p-1">
                        <i class="bi bi-camera"></i>
                    </span>
                </div>

                <div>
                    <h3 class="fw-bold mb-1">Palm Grove Park</h3>
                    <div class="text-muted small">
                        377 Barangay 8 St., Alcantara, Cebu
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <ul class="nav nav-tabs mt-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#">Overview</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Inventory</a>
                </li>
            </ul>

            <!-- CONTENT -->
            <div class="mt-4">
                <div class="card bg-dark text-white border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold">Overview</h6>
                        <p class="text-muted mb-0">
                            This is the profile overview section.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const sidebar = document.querySelector('.admin-sidebar');
    const desktopToggle = document.getElementById('desktopSidebarToggle');
    const mobileToggle = document.getElementById('sidebarToggle');
    const overlay = document.querySelector('.sidebar-overlay');

    if(window.innerWidth >= 768) sidebar.classList.add('expanded');
    desktopToggle?.addEventListener('click', () => sidebar.classList.toggle('expanded'));
    mobileToggle?.addEventListener('click', () => { sidebar.classList.toggle('expanded'); overlay.classList.toggle('active'); });
    overlay?.addEventListener('click', () => { sidebar.classList.remove('expanded'); overlay.classList.remove('active'); });

    // Notifications
    const notifBell = document.getElementById('notifBell');
    const notifPopup = notifBell?.querySelector('.notif-popup');
    notifBell?.addEventListener('click', () => { notifPopup.style.display = (notifPopup.style.display==='block')?'none':'block'; });

    // School Year dropdown
    const schoolYearDropdown = document.getElementById("schoolYearDropdown");
    if(schoolYearDropdown){
        schoolYearDropdown.addEventListener("change", function(){
            const year = this.value;
            document.cookie = "SelectedSchoolYear="+year+"; path=/";
            const url = new URL(window.location.href);
            url.searchParams.set("schoolYear", year);
            window.location.href = url.toString();
        });
    }

    // Profile SPA JS
    const mainContent = document.getElementById("adminMainContent");
    const viewProfileBtn = document.getElementById("viewProfileBtn");
    const originalDashboardHTML = mainContent.innerHTML;

    viewProfileBtn?.addEventListener("click", () => {
        mainContent.style.opacity = 0;
        setTimeout(() => {
            const template = document.getElementById("profileTemplate").innerHTML;
            mainContent.innerHTML = template;
            document.querySelector(".topbar-title").textContent = "Profile";

            // Tab switching
            const profileTabs = document.querySelectorAll('.profile-page .nav-link');
            const profileContent = document.querySelector('.profile-page .mt-4');

            profileTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    profileTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    if(tab.textContent === 'Overview'){
                        profileContent.innerHTML = `
                        <div class="card bg-dark text-white border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="fw-bold">Overview</h6>
                                <p class="text-muted mb-0">
                                    This is the profile overview section.
                                </p>
                            </div>
                        </div>`;
                    } else if(tab.textContent === 'Inventory'){
                        profileContent.innerHTML = `
                        <div class="card bg-dark text-white border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="fw-bold">Inventory</h6>
                                <p class="text-muted mb-0">
                                    Inventory items will appear here.
                                </p>
                            </div>
                        </div>`;
                    }
                });
            });

            mainContent.style.opacity = 1;
        }, 200);
    });

    // Optional: go back to dashboard
    document.getElementById("dashboardBtn")?.addEventListener("click", () => {
        mainContent.style.opacity = 0;
        setTimeout(() => {
            mainContent.innerHTML = originalDashboardHTML;
            document.querySelector(".topbar-title").textContent = "Dashboard";
            mainContent.style.opacity = 1;
        }, 200);
    });

    // Keep your modal preview / edit JS intact (no removal)
    function previewImage(input, targetId){
        const file = input.files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = e => document.getElementById(targetId).src = e.target.result;
            reader.readAsDataURL(file);
        }
    }

    document.getElementById('editProfilePicBtnModal')?.addEventListener('click', ()=> document.getElementById('profilePicInputModal').click());
    document.getElementById('editBannerBtnModal')?.addEventListener('click', ()=> document.getElementById('bannerInputModal').click());

    const editInfoBtn = document.getElementById('editAdminInfoBtn');
    const saveInfoBtn = document.getElementById('saveAdminInfoBtn');
    const adminInfoTable = document.getElementById('adminInfoTable');
    let isEditing = false;

    editInfoBtn?.addEventListener('click', ()=>{
        isEditing = !isEditing;
        adminInfoTable.querySelectorAll('tbody tr').forEach(row=>{
            const valueCell = row.cells[1];
            if(isEditing){
                const val = valueCell.textContent.trim();
                valueCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${val}">`;
            } else {
                const input = valueCell.querySelector('input');
                if(input) valueCell.textContent = input.value;
            }
        });
        editInfoBtn.innerHTML = isEditing ? '<i class="bi bi-x-circle"></i> Cancel' : '<i class="bi bi-pencil"></i> EDIT';
    });

    // ================= DARK MODE TOGGLE =================
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");

    // Load saved theme
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
        themeIcon.classList.replace("bi-moon-fill", "bi-sun-fill");
    }

    themeToggle?.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");

        const isDark = document.body.classList.contains("dark-mode");

        themeIcon.classList.toggle("bi-moon-fill", !isDark);
        themeIcon.classList.toggle("bi-sun-fill", isDark);

        localStorage.setItem("theme", isDark ? "dark" : "light");
    });

</script>

@RenderSection("Scripts", required: false)
</body>
</html>
