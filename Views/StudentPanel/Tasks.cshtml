@model List<MonitoringSystem.Models.StudentTask>

@{
    Layout = "_StudentLayout";
    ViewData["Title"] = "TASK LIST";
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
<input type="hidden" id="__RequestVerificationToken"
       value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />

<div class="container-fluid py-5">
    <div class="card shadow-sm rounded-4 p-4 task-card">

        <!-- Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <h5 class="fw-bold mb-0">TASK LIST</h5>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-danger" id="createTaskBtn">Create Task</button>
                <a href="@Url.Action("DownloadTasks", "Student")" class="btn btn-primary">Download File</a>
            </div>
        </div>

        <!-- ================= FILTERS ================= -->
        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-semibold">Search by Task</label>
                <input type="text" id="searchInput" class="form-control filter-box"
                       placeholder="Type task title..." />
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Status</label>
                <select id="statusFilter" class="form-select filter-box">
                    <option value="">All</option>
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Overdue">Overdue</option>
                </select>
            </div>
        </div>

        <!-- ================= TASK TABLE ================= -->
        <div class="table-responsive">
            <table class="table table-hover table-borderless align-middle mb-0" id="taskTable">
                <thead class="table-light">
                    <tr>
                        <th style="width:5%">#</th>
                        <th style="width:40%" class="text-center">Task Title</th>
                        <th style="width:20%">Deadline</th>
                        <th style="width:15%">Status</th>
                        <th class="text-end" style="width:20%">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        int index = 1;
                        foreach (var task in Model)
                        {
                            <tr data-id="@task.Id"
                                data-title="@task.Title"
                                data-deadline="@task.Deadline.ToString("yyyy-MM-dd")"
                                data-status="@task.Status"
                                data-description="@task.Description">
                                <td>@index</td>
                                <td class="text-center fw-semibold">@task.Title</td>
                                <td>@task.Deadline.ToString("yyyy-MM-dd")</td>
                                <td>@task.Status</td>
                                <td class="text-end">
                                    <div class="dropdown dropend d-inline-block">
                                        <button class="btn btn-sm btn-light dropdown-toggle"
                                                type="button" data-bs-toggle="dropdown"></button>
                                        <ul class="dropdown-menu shadow-sm">
                                            <li><a class="dropdown-item view-btn" href="#">View</a></li>
                                            <li><a class="dropdown-item edit-btn" href="#">Edit</a></li>
                                            <li><a class="dropdown-item delete-btn" href="#">Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            index++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center">No tasks found.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- ================= VIEW MODAL ================= -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content rounded-4 shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Title:</strong> <span id="viewTitle"></span></p>
                <p><strong>Deadline:</strong> <span id="viewDeadline"></span></p>
                <p><strong>Status:</strong> <span id="viewStatus"></span></p>
                <p><strong>Description:</strong></p>
                <p id="viewDescription" class="text-muted"></p>
            </div>
        </div>
    </div>
</div>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content rounded-4 shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editTaskId" name="Id">
                    <div class="mb-3">
                        <label class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="editTaskTitle" name="Title">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Deadline</label>
                        <input type="date" class="form-control" id="editDeadline" name="Deadline">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select id="editStatus" name="Status" class="form-select">
                            <option>Pending</option>
                            <option>Completed</option>
                            <option>Overdue</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assigned To</label>
                        <input type="text" class="form-control" id="editAssignedTo" name="AssignedTo">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="Description"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= CREATE TASK MODAL ================= -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content rounded-4 shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Create Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Task Title</label>
                        <input type="text" name="Title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Deadline</label>
                        <input type="date" name="Deadline" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="Description" class="form-control"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attach File</label>
                        <input type="file" name="Attachment" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-danger w-100">Submit Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const tbody = document.querySelector("#taskTable tbody");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const token = document.getElementById("__RequestVerificationToken").value;

    function filterTable() {
        const searchVal = searchInput.value.toLowerCase();
        const statusVal = statusFilter.value;

        [...tbody.rows].forEach(row => {
            let show = true;
            if (searchVal && !row.dataset.title.toLowerCase().includes(searchVal)) show = false;
            if (statusVal && row.dataset.status !== statusVal) show = false;
            row.style.display = show ? "" : "none";
        });
    }
    [searchInput, statusFilter].forEach(el => el.addEventListener("input", filterTable));

    // ===== VIEW =====
    document.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", e => {
            e.preventDefault();
            const row = btn.closest("tr");
            viewTitle.innerText = row.dataset.title;
            viewDeadline.innerText = row.dataset.deadline;
            viewStatus.innerText = row.dataset.status;
            viewDescription.innerText = row.dataset.description || "—";
            bootstrap.Modal.getOrCreateInstance(viewModal).show();
        });
    });

    // ===== EDIT =====
    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", e => {
            e.preventDefault();
            const row = btn.closest("tr");

            editTaskId.value = row.dataset.id;
            editTaskTitle.value = row.dataset.title;
            editDeadline.value = row.dataset.deadline;
            editStatus.value = row.dataset.status;
            editDescription.value = row.dataset.description;

            bootstrap.Modal.getOrCreateInstance(editModal).show();
        });
    });

    document.getElementById("editForm").addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const res = await fetch("/Student/UpdateTask", {
            method: "POST",
            headers: { "RequestVerificationToken": token },
            body: formData
        });
        const data = await res.json();
        if (data.success) location.reload();
        else alert("Update failed");
    });

    // ===== DELETE =====
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
            e.preventDefault();
            const row = btn.closest("tr");
            if (!confirm("Delete this task?")) return;

            const res = await fetch("/Student/DeleteTask/" + row.dataset.id, {
                method: "POST",
                headers: { "RequestVerificationToken": token }
            });
            const data = await res.json();
            if (data.success) row.remove();
            else alert("Delete failed");
        });
    });

    // ===== CREATE =====
    createTaskBtn.addEventListener("click", () => {
        bootstrap.Modal.getOrCreateInstance(createModal).show();
    });

    createForm.addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const res = await fetch("/Student/CreateTask", {
            method: "POST",
            headers: { "RequestVerificationToken": token },
            body: formData
        });
        const data = await res.json();
        if (data.success) location.reload();
        else alert("Failed to submit task");
    });
</script>
