@model List<MonitoringSystem.Models.StudentTask>

@{
    Layout = "_StudentLayout";
    ViewData["Title"] = "TASK LIST";
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
<input type="hidden" id="__RequestVerificationToken"
       value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />

<div class="container-fluid py-5">
    <div class="card shadow-sm rounded-4 p-4 task-card">

        <!-- Header: Create Task on top-right -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0">TASK LIST</h5>
            <button class="btn btn-primary" id="createTaskBtn">Create Task</button>
        </div>

        <!-- ================= FILTERS ================= -->
        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-semibold">Search by Title</label>
                <input type="text" id="searchInput" class="form-control filter-box"
                       placeholder="Type task title..." />
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Status</label>
                <select id="statusFilter" class="form-select filter-box">
                    <option value="">All</option>
                    <option value="Ongoing">Ongoing</option>
                    <option value="Completed">Completed</option>
                    <option value="Aborted">Aborted</option>
                </select>
            </div>
        </div>

        <!-- ================= TASK TABLE ================= -->
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="taskTable" style="min-width:800px;">
                <thead class="table-light">
                    <tr>
                        <th class="text-center" style="width:30%; padding:20px 16px;">Title</th>
                        <th style="width:15%; padding:20px 16px;">Date From</th>
                        <th style="width:15%; padding:20px 16px;">Date To</th>
                        <th style="width:15%; padding:20px 16px;">Status</th>
                        <th class="text-center" style="width:20%; padding:20px 16px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        foreach (var task in Model)
                        {
                            var sampleDateTo = task.Deadline.AddDays(3).ToString("yyyy-MM-dd");

                            <tr data-id="@task.Id"
                                data-title="@task.Title"
                                data-datefrom="@task.Deadline.ToString("yyyy-MM-dd")"
                                data-dateto="@sampleDateTo"
                                data-status="@task.Status"
                                data-taskcontent=""
                                style="height:70px;">
                                <td class="text-center fw-semibold">@task.Title</td>
                                <td>@task.Deadline.ToString("yyyy-MM-dd")</td>
                                <td>@sampleDateTo</td>
                                <td class="task-status">@task.Status</td>
                                <td class="text-center">
                                    <div class="dropdown d-inline-block">
                                        <button class="btn btn-sm btn-light dropdown-toggle p-2" type="button" data-bs-toggle="dropdown"></button>
                                        <ul class="dropdown-menu shadow-sm">
                                            <li><a class="dropdown-item edit-btn" href="#">Edit</a></li>
                                            <li><a class="dropdown-item delete-btn" href="#">Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-4">No tasks found.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ================= CREATE TASK MODAL ================= -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-4 shadow-sm p-4">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Create Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" name="Title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" name="DateFrom" required>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" name="DateTo" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="Status">
                                <option selected>Ongoing</option>
                                <option>Completed</option>
                                <option>Aborted</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Task</label>
                            <div id="taskEditor" contenteditable="true"
                                 class="form-control"
                                 style="height:220px; overflow:auto; border:1px solid #ced4da; border-radius:4px; padding:0.375rem 0.75rem;">
                            </div>
                            <small class="text-muted">Press Enter for new bullet.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Learning</label>
                            <textarea class="form-control" name="Learning" rows="12" style="height:220px;"></textarea>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn me-2" id="cancelBtn" style="background-color:#FE5252; color:white;" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn" id="createBtn" style="background-color:#02B508; color:white;">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= DELETE CONFIRMATION MODAL ================= -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <!-- compact & slightly wider -->
        <div class="modal-content rounded-4 shadow-sm" style="background-color:#8B0000; color:white;">
            <div class="modal-body text-center py-4">
                <p id="deleteModalText" class="fw-bold mb-0" style="font-size:1rem;"></p> <!-- Bold, fits in one line -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn" id="confirmDeleteBtn" style="background-color:#02B508; color:white;">Yes</button>
                    <button type="button" class="btn" id="cancelDeleteBtn" style="background-color:#FD0606; color:white;" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const tbody = document.querySelector("#taskTable tbody");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const createModal = document.getElementById("createModal");
    const taskEditor = document.getElementById("taskEditor");
    const modalTitle = document.querySelector("#createModal .modal-title");
    const createBtn = document.getElementById("createBtn");

    let editingRow = null;
    let deletingRow = null;

    // ===== FILTER TABLE =====
    function filterTable() {
        const searchVal = searchInput.value.toLowerCase();
        const statusVal = statusFilter.value;

        [...tbody.rows].forEach(row => {
            let show = true;
            if (searchVal && !row.dataset.title.toLowerCase().includes(searchVal)) show = false;
            if (statusVal && row.dataset.status !== statusVal) show = false;
            row.style.display = show ? "" : "none";
        });
    }
    [searchInput, statusFilter].forEach(el => el.addEventListener("input", filterTable));

    // ===== OPEN CREATE TASK MODAL =====
    document.getElementById("createTaskBtn").addEventListener("click", () => {
        editingRow = null;
        modalTitle.textContent = "Create Task";
        document.getElementById("createForm").reset();
        taskEditor.innerHTML = "<ul><li><br></li></ul>";
        bootstrap.Modal.getOrCreateInstance(createModal).show();
    });

    // ===== CREATE / EDIT BUTTON =====
    createBtn.addEventListener("click", () => {
        const title = document.querySelector("input[name='Title']").value;
        const dateFrom = document.querySelector("input[name='DateFrom']").value;
        const dateTo = document.querySelector("input[name='DateTo']").value;
        const status = document.querySelector("select[name='Status']").value;
        const taskContent = taskEditor.innerHTML;

        if (!title || !dateFrom || !dateTo) { alert("Please fill in all fields!"); return; }

        if (editingRow) {
            editingRow.dataset.title = title;
            editingRow.dataset.datefrom = dateFrom;
            editingRow.dataset.dateto = dateTo;
            editingRow.dataset.status = status;
            editingRow.dataset.taskContent = taskContent;

            editingRow.querySelector("td:nth-child(1)").textContent = title;
            editingRow.querySelector("td:nth-child(2)").textContent = dateFrom;
            editingRow.querySelector("td:nth-child(3)").textContent = dateTo;
            editingRow.querySelector("td:nth-child(4)").textContent = status;

            editingRow = null;
        } else {
            const newRow = document.createElement("tr");
            newRow.dataset.title = title;
            newRow.dataset.datefrom = dateFrom;
            newRow.dataset.dateto = dateTo;
            newRow.dataset.status = status;
            newRow.dataset.taskContent = taskContent;
            newRow.innerHTML = `
                <td class="text-center fw-semibold">${title}</td>
                <td>${dateFrom}</td>
                <td>${dateTo}</td>
                <td class="task-status">${status}</td>
                <td class="text-center">
                    <div class="dropdown d-inline-block">
                        <button class="btn btn-sm btn-light dropdown-toggle p-2" type="button" data-bs-toggle="dropdown"></button>
                        <ul class="dropdown-menu shadow-sm">
                            <li><a class="dropdown-item edit-btn" href="#">Edit</a></li>
                            <li><a class="dropdown-item delete-btn" href="#">Delete</a></li>
                        </ul>
                    </div>
                </td>
            `;
            tbody.appendChild(newRow);
        }

        bootstrap.Modal.getOrCreateInstance(createModal).hide();
        document.getElementById("createForm").reset();
        taskEditor.innerHTML = "<ul><li><br></li></ul>";
    });

    // ===== CANCEL BUTTON =====
    document.getElementById("cancelBtn").addEventListener("click", () => {
        document.getElementById("createForm").reset();
        taskEditor.innerHTML = "<ul><li><br></li></ul>";
        editingRow = null;
    });

    // ===== EDIT & DELETE DROPDOWN =====
    document.addEventListener("click", (e) => {
        // Edit
        if(e.target.classList.contains("edit-btn")){
            e.preventDefault();
            editingRow = e.target.closest("tr");
            modalTitle.textContent = "Edit Task";
            document.querySelector("input[name='Title']").value = editingRow.dataset.title;
            document.querySelector("input[name='DateFrom']").value = editingRow.dataset.datefrom;
            document.querySelector("input[name='DateTo']").value = editingRow.dataset.dateto;
            document.querySelector("select[name='Status']").value = editingRow.dataset.status;
            taskEditor.innerHTML = editingRow.dataset.taskContent || "<ul><li><br></li></ul>";
            bootstrap.Modal.getOrCreateInstance(createModal).show();
        }

        // Delete
        if(e.target.classList.contains("delete-btn")){
            e.preventDefault();
            deletingRow = e.target.closest("tr");
            const taskTitle = deletingRow.dataset.title;
            document.getElementById("deleteModalText").textContent = `Are you sure you want to delete this task "${taskTitle}"?`;
            bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteModal")).show();
        }
    });

    // ===== CONFIRM DELETE =====
    document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
        if(deletingRow){
            deletingRow.remove();
            deletingRow = null;
            bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteModal")).hide();
        }
    });
</script>
